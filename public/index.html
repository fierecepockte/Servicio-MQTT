<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Smart Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* Agregamos estilos para el log de depuraci√≥n */
        .debug-log {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            height: 150px;
            overflow-y: scroll;
            text-align: left;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üè† Panel de Seguridad</h1>
        
        <div id="status-connection" class="status-dot disconnected">Desconectado</div>

        <div class="card" id="card-alarma">
            <h2>üö® ALARMA</h2>
            <div id="estado-alarma" class="display-text">OFF</div>
            <button onclick="apagarAlarma()" class="btn btn-danger">APAGAR ALARMA</button>
        </div>

        <div class="card">
            <h2>üõ°Ô∏è Modo Seguridad</h2>
            <div id="estado-seguridad" class="display-text">DESACTIVADO</div>
            <div class="btn-group">
                <button onclick="setSeguridad('ACTIVAR')" class="btn btn-primary">Activar</button>
                <button onclick="setSeguridad('DESACTIVAR')" class="btn btn-secondary">Desactivar</button>
            </div>
        </div>

        <div class="monitor">
            <h3>Estado de Sensores</h3>
            <p>üö™ Puerta: <span id="val-puerta">-</span></p>
            <p>ü™ü Ventana: <span id="val-ventana">-</span></p>
        </div>

        <div class="debug-log" id="console-log">
            Iniciando sistema...<br>
        </div>
    </div>

    <script>
        // Funci√≥n para escribir en el log de la pantalla
        function log(msg) {
            const box = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        }

        // Determinar protocolo (wss en render, ws en local)
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const host = `${protocol}://${window.location.host}`;

        log(`Intentando conectar a: ${host}`);

        const client = mqtt.connect(host);

        client.on('connect', () => {
            log("‚úÖ ¬°Conectado al Servidor!");
            document.getElementById('status-connection').className = 'status-dot connected';
            document.getElementById('status-connection').innerText = 'Conectado';
            
            // Nos suscribimos para escuchar las respuestas del servidor
            client.subscribe('sistema/estado/#');
            client.subscribe('casa/#');
            log("Suscrito a los canales de estado.");
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();
            log(`üì© Recibido [${topic}]: ${msg}`);
            
            if (topic === 'sistema/estado/alarma') {
                const el = document.getElementById('estado-alarma');
                el.innerText = msg;
                if(msg === 'ON') {
                    document.getElementById('card-alarma').classList.add('alert-mode');
                } else {
                    document.getElementById('card-alarma').classList.remove('alert-mode');
                }
            }
            else if (topic === 'sistema/estado/seguridad') {
                document.getElementById('estado-seguridad').innerText = msg;
            }
            else if (topic === 'casa/puertas') {
                document.getElementById('val-puerta').innerText = msg;
            }
            else if (topic === 'casa/ventanas') {
                document.getElementById('val-ventana').innerText = msg;
            }
        });

        client.on('error', (err) => {
            log("‚ùå Error de conexi√≥n: " + err);
            console.error(err);
        });

        client.on('close', () => {
            log("‚ö†Ô∏è Conexi√≥n perdida");
            document.getElementById('status-connection').className = 'status-dot disconnected';
            document.getElementById('status-connection').innerText = 'Desconectado';
        });

        // Funciones de botones
        function setSeguridad(accion) {
            if (!client.connected) {
                log("‚ùå No se puede enviar: No est√°s conectado.");
                return;
            }
            log(`üì§ Enviando orden: Seguridad -> ${accion}`);
            client.publish('sistema/control/seguridad', accion);
        }

        function apagarAlarma() {
            if (!client.connected) {
                log("‚ùå No se puede enviar: No est√°s conectado.");
                return;
            }
            log(`üì§ Enviando orden: APAGAR ALARMA`);
            client.publish('sistema/control/alarma', 'APAGAR');
        }
    </script>
</body>
</html>